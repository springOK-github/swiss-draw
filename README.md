# ポケモンカード・ガンスリンガーバトル マッチングシステム

Google Apps Script (GAS) とスプレッドシートで動作するポケモンカードバトル大会のマッチングシステムです。

## 機能一覧

- プレイヤー登録・管理
- 自動マッチング（再戦回避機能付き）
  - 勝者優先マッチング（勝数が多い順、同勝数なら先着順）
  - 過去対戦相手の自動記録と再戦回避
  - 卓番号の自動管理と再利用
- 対戦結果記録
  - 勝敗統計の自動更新（勝数・敗数・消化試合数）
  - 対戦履歴の記録
- プレイヤー休憩・復帰処理
- プレイヤードロップアウト処理

## プレイヤーの状態遷移

1. 待機: マッチング待ち
2. 対戦中: 対戦進行中
3. 休憩: 一時的に対戦から離脱（復帰可能）
4. 終了: ドロップアウト済み（復帰不可）

## 主な特徴

### 再戦回避システム
- 過去に対戦した相手との再戦を自動的に回避
- 全員が過去対戦者の場合はマッチングを成立させず待機継続

### 勝者優先マッチング
- 勝数が多いプレイヤーを優先的にマッチング
- 同じ勝数の場合は先着順（最終対戦日時が古い順）を優先

### 卓番号管理
- 対戦終了後も卓番号を保持し、勝者が同じ卓を再利用
- 最大卓数は1～200の範囲で動的に設定可能（デフォルト: 50卓）
- カスタムメニューから現在の設定卓数を確認・変更可能
- 物理的な卓配置と連動した運用が可能

### 自動統計管理
- 勝数・敗数・消化試合数を自動集計
- 対戦履歴の完全な記録
- 最終対戦日時の自動更新

## ファイル構成

関連機能をドメインごとにまとめた構成になっています。

### ドメイン層
- **`player-domain.js`**: プレイヤードメイン
  - プレイヤー操作（登録・休憩・復帰・ドロップアウト）
  - プレイヤーデータ取得・検索
  - プレイヤー統計更新
  - プレイヤー状態遷移
  
- **`match-domain.js`**: 対戦ドメイン
  - マッチング管理（自動マッチング、再戦回避）
  - 対戦結果記録
  - 対戦結果修正

### 共通層
- **`shared.js`**: 共有ユーティリティ
  - シート操作ユーティリティ（データ取得、構造検証）
  - UI共通処理（プロンプト、状態変更）

### アプリケーション層
- **`app.js`**: アプリケーション層
  - システム初期化・カスタムメニュー
  - システム設定管理（最大卓数など）
  - 排他制御（複数ユーザーの同時操作防止）

### その他
- **`constants.js`**: システム全体で使用する定数の定義
- `test-utils.js`: テスト用のユーティリティ関数
- `README.js`: README自動生成用スクリプト

## セットアップ方法

1. Google スプレッドシートを新規作成
2. ツール → スクリプトエディタを開く
3. 上記の各ファイルをスクリプトエディタにコピー
4. スプレッドシートを更新すると、カスタムメニューが表示される

## 使用方法

1. スプレッドシートのカスタムメニューから「初期設定」を実行
2. プレイヤーシートにプレイヤー情報を登録
3. カスタムメニューから「マッチング実行」を選択
4. 対戦結果を記録
5. 必要に応じてプレイヤーの休憩・復帰・ドロップアウト処理を実行

### 主なカスタムメニュー操作

- **プレイヤー追加**: 新しいプレイヤーを追加（自動ID採番）
- **対戦結果の記録**: 勝者を指定して対戦を終了（統計自動更新）
- **プレイヤーを休憩にする**: 一時的に対戦から離脱（後で復帰可能）
- **休憩から復帰させる**: 休憩中のプレイヤーを待機状態に戻す（自動マッチング発動）
- **プレイヤーをドロップアウトさせる**: 大会から完全に退出（復帰不可）
- **最大卓数を設定**: 使用する卓の最大数を設定（1～200、デフォルト: 50）

### データシート構成

システムは以下の3つのシートを使用します：

1. **プレイヤーシート**: プレイヤーマスタ
   - プレイヤーID、名前、勝敗数、消化試合数、参加状況、最終対戦日時

2. **対戦履歴シート**: 完了した対戦の記録
   - 日時、卓番号、両プレイヤーID・名前、勝者名、対戦ID

3. **マッチングシート**: 現在進行中の対戦
   - 卓番号、両プレイヤーID・名前

## 開発者向け情報

### Claspによるローカル開発環境のセットアップ

1. Node.jsをインストール（[公式サイト](https://nodejs.org/)）

2. Claspをグローバルにインストール
```bash
npm install -g @google/clasp
```

3. Googleアカウントにログイン
```bash
clasp login
```

4. プロジェクトのクローン
```bash
# スクリプトIDを指定してクローン
clasp clone "スクリプトID"
```

5. ローカルでの開発
```bash
# ファイルの変更を監視して自動アップロード
clasp push --watch

# 手動でアップロード
clasp push

# 現在のバージョンをデプロイ
clasp deploy
```

### GitHubとの連携

1. リポジトリの作成とクローン
```bash
# GitHubでリポジトリを作成後、ローカルにクローン
git clone https://github.com/ユーザー名/gunslinger.git
cd gunslinger
```

2. Claspプロジェクトとの連携
```bash
# Claspプロジェクトをクローン（既存の場合は省略）
clasp clone "スクリプトID"

# .gitignoreファイルを作成
echo ".clasp.json" >> .gitignore
```

3. 開発ワークフロー
```bash
# GASの変更をプッシュ
clasp push

# GitHubへの変更をプッシュ
git add .
git commit -m "変更内容の説明"
git push origin main

# 他の開発者の変更を取得
git pull origin main
```

4. 推奨事項
- コミットメッセージは日本語で具体的に記述
- `clasp push`と`git push`を併用して、GASとGitHubの両方で最新状態を維持
- 大きな機能追加時はブランチを作成して作業
```

### テスト用関数

テストデータの作成やシステムの動作確認のために、以下の関数が利用可能です：

- `registerTestPlayers()`: テスト用プレイヤーの一括登録（8人）
- その他のテスト用関数は `test-utils.js` を参照

## 技術的特徴

### 並行処理制御
- LockServiceによる排他制御で複数ユーザーの同時操作に対応
- デッドロック回避のため、ロック取得順序を固定

### データ整合性
- すべてのシート操作で必須ヘッダーを検証
- 列インデックスを動的に取得し、列順変更に対応
- 状態遷移は`updatePlayerState()`関数で一元管理

### パフォーマンス最適化
- マッチング処理で Map/Set を活用した O(1) 検索
- シートアクセスを最小化（一括データ取得とキャッシング）
- プレイヤー名と対戦履歴を事前構築して高速化
- 小規模（10人）で2-3倍、大規模（50人）で6-10倍の高速化を実現

### 柔軟な設計
- 設定ファイル（`constants.js`）で最大卓数やID桁数を調整可能
- 卓番号の自動割り当てと再利用により、運用効率を向上
- モジュール化されたファイル構成で保守性を確保

## 作者

SpringOK

## ライセンス

このプロジェクトは非公開です。無断での使用、配布、複製は禁止されています。